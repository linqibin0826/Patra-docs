name: Deploy Quartz site to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install D2
        run: |
          curl -fsSL https://d2lang.com/install.sh | sh -s --
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Compile D2 diagrams to SVG
        run: |
          # D2 编译脚本 - 支持 ```d2 和 ```d2 width=xxx 等格式
          set -e

          echo "=== Starting D2 compilation ==="

          # 遍历 content 目录下所有 .md 文件
          find content -name "*.md" -type f | while read -r mdfile; do
            dir=$(dirname "$mdfile")
            filebasename=$(basename "$mdfile" .md)

            # 检查文件是否包含 d2 代码块（支持带参数的格式如 ```d2 width=800）
            if grep -qE '```d2' "$mdfile"; then
              echo "Processing: $mdfile"

              # 创建 assets 目录
              assets_dir="$dir/assets"
              mkdir -p "$assets_dir"

              # 清理之前的临时文件
              rm -f /tmp/d2_temp_*.d2

              # 计算相对于 content 目录的路径，用于生成绝对 URL
              relative_dir="${dir#content/}"

              # 使用 awk 提取 d2 代码块并生成替换后的文件
              awk -v filebasename="$filebasename" -v reldir="$relative_dir" '
                BEGIN { in_d2 = 0; counter = 1; d2_content = "" }
                /^```d2/ {
                  in_d2 = 1
                  d2_content = ""
                  next
                }
                /^```$/ && in_d2 {
                  in_d2 = 0
                  # 保存 d2 内容到临时文件
                  d2_file = "/tmp/d2_temp_" counter ".d2"
                  printf "%s", d2_content > d2_file
                  close(d2_file)

                  # 输出图片引用（使用绝对路径）
                  svg_name = filebasename "-d2-" counter ".svg"
                  print "![D2 Diagram](/" reldir "/assets/" svg_name ")"
                  counter++
                  next
                }
                in_d2 {
                  d2_content = d2_content $0 "\n"
                  next
                }
                { print }
              ' "$mdfile" > "${mdfile}.tmp"

              # 编译所有提取的 d2 文件
              compiled=0
              for d2file in /tmp/d2_temp_*.d2; do
                if [ -f "$d2file" ]; then
                  num=$(basename "$d2file" .d2 | sed 's/d2_temp_//')
                  svg_name="${filebasename}-d2-${num}.svg"
                  svg_path="$assets_dir/$svg_name"

                  echo "  Compiling D2 block $num -> $svg_path"

                  # 尝试使用 elk 布局，失败则回退到默认布局
                  if d2 --theme 0 --layout elk "$d2file" "$svg_path" 2>/dev/null; then
                    echo "    ✓ Compiled with elk layout"
                  elif d2 --theme 0 "$d2file" "$svg_path" 2>/dev/null; then
                    echo "    ✓ Compiled with default layout"
                  else
                    echo "    ✗ Failed to compile, keeping original code block"
                    # 编译失败时不替换原文件
                    rm -f "${mdfile}.tmp"
                    break
                  fi

                  compiled=1
                  rm -f "$d2file"
                fi
              done

              # 只有编译成功才替换原文件
              if [ -f "${mdfile}.tmp" ]; then
                mv "${mdfile}.tmp" "$mdfile"
                echo "  ✓ Updated: $mdfile"
              fi
            fi
          done

          echo "=== D2 compilation complete ==="

          # 显示生成的 SVG 文件
          echo "Generated SVG files:"
          find content -name "*.svg" -type f 2>/dev/null || echo "  (none)"

      - name: Install Dependencies
        run: npm ci

      - name: Build Quartz
        run: npx quartz build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: public

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

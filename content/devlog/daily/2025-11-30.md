---
date: 2025-11-30
type: devlog/daily
time_range: "06:00 - 23:59"
commits: 19
files_changed: 51
lines_added: 4022
lines_deleted: 1585
modules: [starter-observability, starter-core, catalog, docker, docs]
tags: [refactor, feat, fix, docs, test, chore, observability, metrics, otel]
linked_bugs: [BUG-002-loki-grpc-message-size-limit]
linked_tils: []
linked_adrs: []
---

# 2025-11-30 开发日志

## 变更统计

| 指标 | 数值 |
|------|------|
| 提交数 | 19 |
| 修改文件 | 51 |
| 新增行数 | +4022 |
| 删除行数 | -1585 |
| 涉及模块 | starter-observability, starter-core, catalog, docker, docs |

## 提交记录

### patra-spring-boot-starter-observability (核心重构)

| 时间 | 提交 | 说明 |
|------|------|------|
| 23:02 | `76f24503` | refactor: 移除 MetricNamingMeterFilter，指标前缀统一由 OTel Collector 处理 |
| 20:28 | `c28153f0` | docs: 更新文档反映 OTel Agent Micrometer Bridge 架构 |
| 20:27 | `48afec3d` | test: 添加 MeterFilter 和 OTel Bridge 单元测试 |
| 20:26 | `df3e35b4` | refactor: 重构 Metrics 导出架构为 OTel Agent Micrometer Bridge |
| 10:00 | `0f7ef529` | test: 添加 MicrometerAutoConfiguration fallback 逻辑测试 |
| 09:59 | `a6269ed1` | feat: 实现配置属性零配置自动获取 |

### patra-spring-boot-starter-core

| 时间 | 提交 | 说明 |
|------|------|------|
| 14:34 | `6b8822a1` | fix: 修复 Logback conversionRule 废弃属性警告 |
| 09:59 | `61f5fb4e` | refactor: 删除冗余的 SegmentIdConverter |

### patra-catalog

| 时间 | 提交 | 说明 |
|------|------|------|
| 23:04 | `c5260eac` | feat: 扩展 LexicalTag 词法标记枚举支持更多 MeSH 类型 |

### Docker / OTel 配置

| 时间 | 提交 | 说明 |
|------|------|------|
| 23:03 | `1264f944` | chore: 优化 OTel Collector 和 Loki 资源配置，添加 Spring Batch 监控面板 |
| 15:28 | `7f0f6653` | fix: 启用 local-blocks 处理器修复 Tempo Drilldown 查询 |
| 14:50 | `6b0efc83` | chore: 添加 IntelliJ 运行配置并外部化 OpenTelemetry 配置 |
| 14:34 | `5b662967` | fix: 增加 gRPC 消息大小限制解决 OTLP 日志查询失败 |

### 文档

| 时间 | 提交 | 说明 |
|------|------|------|
| 23:03 | `9e59b29d` | docs: 更新文档反映 OTel Collector 指标前缀机制 |
| 15:28 | `6ffc1ce5` | docs: 添加可观测性开发规范 |
| 10:01 | `073a58e1` | docs: 精简架构规范文档 |
| 10:00 | `7df6c924` | docs: 更新可观测性系统设计文档 |

### 服务配置

| 时间 | 提交 | 说明 |
|------|------|------|
| 20:27 | `13cddc4d` | chore: 适配 OTel Agent Micrometer Bridge 统一 Metrics 导出 |
| 10:00 | `42b1a7d3` | chore: 简化服务可观测性配置为零配置模式 |

## 今日完成

### 🎯 可观测性架构重大重构

**核心变更**：将 Metrics 导出架构从「应用内 OTLP 推送」改为「OTel Agent Micrometer Bridge」模式

1. **架构简化**：
   - 移除 `MetricNamingMeterFilter`，指标前缀由 OTel Collector 统一处理
   - 删除冗余的 `SegmentIdConverter`（日志 segment ID 格式化）
   - 实现配置属性零配置自动获取，减少服务配置负担

2. **OTel Agent 桥接机制**：
   - 实现 `otelMeterRegistryBridge()` 将 Agent 注入的 MeterRegistry 暴露为 Spring Bean
   - 解决 Spring Boot Actuator 默认 `SimpleMeterRegistry` 与 OTel Agent 冲突问题
   - 统一 Micrometer 指标通过 Agent OTLP 通道导出

3. **基础设施修复**：
   - 修复 Loki gRPC 消息大小限制导致的 OTLP 日志查询失败
   - 修复 Tempo local-blocks 处理器配置导致的 Drilldown 查询问题
   - 修复 Logback `conversionRule` 废弃属性警告

4. **测试覆盖**：
   - 添加 MeterFilter 系列单元测试（CommonTags、HighCardinality、MetricNaming）
   - 添加 OTel Bridge 集成测试验证 MeterRegistry 桥接逻辑
   - 添加 MicrometerAutoConfiguration fallback 逻辑测试

### 📚 Catalog 领域扩展

- 扩展 `LexicalTag` 词法标记枚举，支持更多 MeSH 术语类型（QAB、QEV、QSV 等）

### 🛠️ 开发体验优化

- 添加 IntelliJ 运行配置（5 个服务）
- 外部化 OpenTelemetry Agent 配置文件

## 明日计划

> 以下是基于今日变更和未完成任务的建议，请确认或修改：

1. **可观测性验证**：
   - [x] 在完整的 Docker Compose 环境中验证 Metrics → Prometheus → Grafana 流水线
   - [x] 验证新的 Spring Batch 监控面板数据展示是否正确

2. **LexicalTag 集成**：
   - [x] 验证新增的 MeSH 词法标记在实际数据解析中的使用情况
   - [x] 补充 MeSH 术语类型的文档说明

3. **代码质量**：
   - [x] 考虑为 starter-observability 添加 README 使用说明更新
   - [x] 检查其他 starter 模块是否有类似的配置简化机会

## 关联

- Bug: [[bugs/2025/11/BUG-002-loki-grpc-message-size-limit|BUG-002: Loki gRPC 消息大小限制]]
- TIL: -
- ADR: -

## 备注

今日主要完成了可观测性模块的重大架构重构，从应用内 OTLP 推送模式迁移到 OTel Agent Micrometer Bridge 模式。这一变更带来了几个关键优势：

1. **架构简化**：应用不再需要关心 Metrics 的导出细节，只需使用 Micrometer API
2. **统一管道**：Traces/Metrics/Logs 全部通过 OTel Agent → OTLP → Collector 统一管道
3. **零配置**：服务启动时自动获取配置，无需手动设置 `application`、`environment` 等属性

同时修复了几个在调试过程中发现的基础设施问题（Loki gRPC 限制、Tempo Drilldown 查询），并记录了相关的 Bug 文档。

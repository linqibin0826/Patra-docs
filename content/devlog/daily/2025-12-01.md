---
date: 2025-12-01
type: devlog/daily
time_range: "06:00 - 23:54"
commits: 21
files_changed: 115
lines_added: 19366
lines_deleted: 7659
modules: [patra-catalog, patra-spring-boot-starter-rest-client, patra-spring-boot-starter-object-storage, patra-spring-boot-starter-core, patra-spring-boot-starter-batch, docker, docs]
tags: [feat, refactor, fix, docs, chore, ci]
linked_bugs: ["[[bugs/2025/12/BUG-003-spring-batch-faulttolerant-hides-root-cause|BUG-003]]"]
linked_tils: ["[[til/2025/12/2025-12-01-quartz-docs-site-setup|TIL: Quartz 文档站点]]"]
linked_adrs: ["[[decisions/ADR-009-rest-client-download-progress-monitoring|ADR-009]]"]
---

# 2025-12-01 开发日志

## 变更统计

| 指标 | 数值 |
|------|------|
| 提交数 | 21 |
| 修改文件 | 115 |
| 新增行数 | +19,366 |
| 删除行数 | -7,659 |
| 涉及模块 | catalog, rest-client, object-storage, core, batch, docker, docs |

> [!note] 统计说明
> 删除行数包含 docker 配置迁移到 patra-infra 仓库的 6,615 行。实际有效删除约 1,044 行。

## 提交记录

### patra-spring-boot-starter-rest-client

| 时间 | 提交 | 类型 | 描述 |
|------|------|------|------|
| 22:13 | `0779aa52` | feat | 添加文件下载进度监控功能 |

**详情**：实现了 `DownloadClient` 接口，支持下载进度回调、日志记录和 Micrometer 指标采集。包含 `ProgressListener` 扩展点、`DownloadProgress` 值对象和 `MetricsProgressListener` 指标集成。

### patra-spring-boot-starter-object-storage

| 时间 | 提交 | 类型 | 描述 |
|------|------|------|------|
| 16:18 | `4ece7423` | feat | 添加下载、元数据查询和存在性检查功能 |

**详情**：重构 `ObjectStorageOperations` 接口，新增 `download()`、`getObjectInfo()`、`exists()` 方法。引入 `AbstractObjectStorageProvider` 抽象基类统一异常处理和指标采集。

### patra-catalog

| 时间 | 提交 | 类型 | 描述 |
|------|------|------|------|
| 22:13 | `890f2917` | refactor | 重构 FileDownloadAdapter 使用 DownloadClient |
| 20:35 | `74d6e036` | chore | 更新开发环境 MinIO 端口和日志配置 |
| 20:34 | `4a156c51` | refactor | 使用 ObjectProvider 替代 @ConditionalOnBean 条件装配 |
| 20:34 | `311883de` | fix | 修复 Spring Batch FaultTolerant 掩盖原始异常问题 |
| 16:19 | `39e09f28` | refactor | 引入 MeshSourceFilePort 统一管理 MeSH 源文件获取和缓存 |

**详情**：
- 重构 `FileDownloadAdapter` 使用新的 `DownloadClient`，移除重复的下载逻辑
- 修复 Spring Batch `FaultTolerant` 模式下异常被 `SkipPolicy` 吞掉的问题，通过 `TransactionalProxySkipPolicy` 在事务外抛出原始异常
- 引入 `MeshSourceFilePort` 端口接口，统一管理 MeSH 源文件的远程获取和本地缓存逻辑

### patra-spring-boot-starter-core

| 时间 | 提交 | 类型 | 描述 |
|------|------|------|------|
| 16:20 | `1102cc4f` | refactor | 使用 Lombok 简化配置类并修复依赖注入 |

### patra-spring-boot-starter-batch

| 时间 | 提交 | 类型 | 描述 |
|------|------|------|------|
| 16:20 | `1102cc4f` | refactor | 使用 Lombok 简化配置类并修复依赖注入 |

### 基础设施 (docker/ci)

| 时间 | 提交 | 类型 | 描述 |
|------|------|------|------|
| 23:51 | `f879dca3` | refactor | 将 docker 配置迁移到 patra-infra 仓库 |
| 16:18 | `b38d4e93` | feat | 添加 OTel Collector Span Metrics Connector 生成 RED 指标 |
| 16:17 | `9297802f` | chore | 统一 Grafana 面板指标前缀为 patra_ |
| 16:02 | `1d9b33d4` | ci | 添加文档自动同步工作流 |
| 15:11 | `ac218685` | fix | 禁用 Liquid 处理避免 Prometheus 模板语法冲突 |
| 09:12 | `395a72d7` | chore | 添加可观测性监控面板并修复 Spring Batch 指标标签 |

### 文档

| 时间 | 提交 | 类型 | 描述 |
|------|------|------|------|
| 22:15 | `594264b4` | docs | 添加 ADR-009 REST 客户端下载进度监控决策记录 |
| 22:14 | `d9c57ece` | docs | 更新可观测性设计文档和基础设施配置 |
| 16:46 | `8bfa3810` | docs | 将 Quartz 文档站点方案从 inbox 归档到 TIL |
| 16:21 | `0bc3c6c0` | docs | 添加 Quartz 文档站点方案并更新开发日志 |
| 09:12 | `3a38d10b` | docs | 添加 2025-11-30 开发日志 |

## 今日完成

### 功能开发

1. **REST Client 下载进度监控** - 实现了完整的文件下载进度追踪功能：
   - `DownloadClient` 核心接口，支持同步/异步下载
   - `ProgressListener` 扩展点，支持自定义进度处理
   - `LoggingProgressListener` 日志输出（5% 步长）
   - `MetricsProgressListener` Micrometer 指标集成
   - 完整的单元测试和集成测试覆盖

2. **Object Storage 功能增强** - 扩展对象存储操作能力：
   - 新增下载、元数据查询、存在性检查方法
   - `AbstractObjectStorageProvider` 抽象基类
   - 统一异常处理和 Micrometer 指标采集
   - 完整测试覆盖（TDD 驱动）

### 重构优化

1. **MeSH 源文件管理重构** - 引入 `MeshSourceFilePort` 统一管理：
   - 远程下载与本地缓存逻辑解耦
   - 支持 ObjectStorage 和本地文件系统双路径
   - 简化 `MeshImportOrchestrator` 职责

2. **FileDownloadAdapter 重构** - 迁移到新的 `DownloadClient`：
   - 移除重复的下载实现
   - 复用 rest-client starter 的进度监控能力

3. **项目结构重组** - Patra 多仓库架构：
   - 新建 **patra-infra** 仓库，承载 docker 配置和可观测性基础设施
   - 新建 **patra-docs** 仓库，作为 GitHub Pages 文档站点
   - patra-api 的 docs 目录更新时，通过 GitHub Action 触发 patra-docs 同步
   - 所有仓库统一在 `~/Desktop/Patra/` 目录下管理

### Bug 修复

1. **Spring Batch 异常掩盖问题** (BUG-003)：
   - `FaultTolerant` 模式下 `SkipPolicy` 吞掉原始异常
   - 实现 `TransactionalProxySkipPolicy` 在事务外重新抛出

### 可观测性

1. **OTel Collector RED 指标** - 添加 Span Metrics Connector 生成 RED 指标
2. **Grafana 面板优化** - 统一 `patra_` 指标前缀
3. **可观测性文档** - 更新设计文档和配置指南

### 文档与 CI

1. **ADR-009** - REST 客户端下载进度监控架构决策记录
2. **文档同步工作流** - GitHub Actions 自动同步到 GitHub Pages
3. **TIL 归档** - Quartz 文档站点方案

## 明日计划

> [!important] 优先级排序

### 高优先级

- [ ] **文档仓库迁移** - 移除 patra-api 中的 docs 目录，统一使用 patra-docs 仓库维护
  - 迁移剩余文档到 patra-docs
  - 更新 GitHub Action 工作流（移除同步逻辑）
  - 更新 patra-api 的 .claude/memories 引用路径
  - 验证 GitHub Pages 正常工作

### 常规任务

- [ ] 验证 patra-infra 仓库的 docker 配置正常工作
- [ ] 完善 `DownloadClient` 异步下载实现的取消/超时处理
- [ ] 为 `MeshSourceFilePort` 添加集成测试验证缓存策略
- [ ] 清理 `PublicationAggregate` 中的 TODO：发布 OA 状态变更事件

## 关联

- Bug: [[bugs/2025/12/BUG-003-spring-batch-faulttolerant-hides-root-cause|BUG-003: Spring Batch FaultTolerant 掩盖原始异常]]
- TIL: [[til/2025/12/2025-12-01-quartz-docs-site-setup|Quartz 文档站点方案]]
- ADR: [[decisions/ADR-009-rest-client-download-progress-monitoring|ADR-009: REST 客户端下载进度监控]]

## 备注

今天是一个高产的开发日，完成了两个重要的 starter 功能增强（rest-client 和 object-storage），同时进行了关键的架构重构。

### Spring Batch 异常处理的坑

`FaultTolerant` 模式下的 `SkipPolicy` 会在事务内捕获异常，导致日志和监控看不到真实的错误原因。解决方案是在事务边界外重新抛出异常，这个经验值得后续在团队内分享。

### Patra 多仓库架构演进

今天完成了项目结构的重大重组，从单仓库演进为多仓库架构：

```
~/Desktop/Patra/
├── patra-api/          # 核心业务代码（本仓库）
├── patra-infra/        # 基础设施配置（docker、监控、部署）
└── patra-docs/         # GitHub Pages 文档站点
```

**架构决策理由**：
1. **关注点分离** - 业务代码与基础设施配置解耦，各自独立演进
2. **部署灵活性** - 基础设施可按环境（dev/prod）独立配置
3. **文档可访问性** - GitHub Pages 提供公开的文档访问入口
4. **CI/CD 简化** - 文档变更自动触发站点更新，无需手动部署

**自动化流程**：`patra-api/docs` → GitHub Action → `patra-docs` → GitHub Pages

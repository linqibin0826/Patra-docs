---
title: useEffect è¿›é˜¶
chapter: 3
section: 3
status: å·²å®Œæˆ
progress:
  started_at: 2025-12-07
  completed_at: 2025-12-07
  time_spent: "2h"
  mastery: ç†Ÿæ‚‰
tags:
  - learning/react/ch03
  - tech/react
  - tech/hooks
  - tech/useEffect
  - tech/closure
---

# useEffect è¿›é˜¶

> æŒæ¡ useEffect æœ€å®¹æ˜“å‡ºé”™çš„åœ°æ–¹â€”â€”é—­åŒ…é™·é˜±ã€ä¾èµ–æ•°ç»„é—®é¢˜å’Œç«æ€æ¡ä»¶

---

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

- [x] ç†è§£é—­åŒ…é™·é˜±ï¼ˆStale Closureï¼‰çš„åŸå› å’Œè¡¨ç°
- [x] æŒæ¡å‡½æ•°å¼æ›´æ–°è§£å†³é—­åŒ…é—®é¢˜
- [x] å­¦ä¼šç”¨ useRef ä½œä¸ºã€Œé€ƒç”Ÿèˆ±ã€ä¿å­˜æœ€æ–°å€¼
- [x] æ­£ç¡®åˆ¤æ–­ä¾èµ–æ•°ç»„è¯¥åŒ…å«å“ªäº›å€¼
- [x] ç†è§£å¯¹è±¡/å‡½æ•°ä¾èµ–å¯¼è‡´æ— é™å¾ªç¯çš„åŸå› 
- [x] æŒæ¡ cancelled æ ‡è®°è§£å†³ç«æ€æ¡ä»¶

---

## ğŸ•³ï¸ é—­åŒ…é™·é˜±ï¼ˆStale Closureï¼‰

### é—®é¢˜ç°è±¡

```tsx
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const timer = setInterval(() => {
      console.log('count:', count);  // æ°¸è¿œè¾“å‡º 0ï¼
      setCount(count + 1);           // æ°¸è¿œè®¾ç½®ä¸º 1ï¼
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  return <div>{count}</div>;  // é¡µé¢æ°¸è¿œæ˜¾ç¤º 1
}
```

### åŸå› åˆ†æ

```
ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  useEffect å›è°ƒè¢«åˆ›å»ºï¼Œã€Œæ‹æ‘„ã€äº†å½“æ—¶çš„ count å€¼          â”‚
â”‚                                                         â”‚
â”‚  setInterval å›è°ƒï¼š                                     â”‚
â”‚    count = 0  â† è¢«ã€Œå†»ç»“ã€åœ¨é—­åŒ…ä¸­                       â”‚
â”‚    setCount(0 + 1) â†’ æ°¸è¿œæ˜¯ 1                           â”‚
â”‚                                                         â”‚
â”‚  ğŸ“¸ é—­åŒ…å¿«ç…§ï¼šcount = 0ï¼ˆæ°¸ä¸æ›´æ–°ï¼‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> [!important] é—­åŒ…çš„æœ¬è´¨
> JavaScript å‡½æ•°ä¼šã€Œè®°ä½ã€å®ƒè¢«åˆ›å»ºæ—¶çš„ç¯å¢ƒã€‚å½“ useEffect çš„å›è°ƒåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶åˆ›å»ºï¼Œå®ƒæ•è·çš„ `count` å°±æ˜¯å½“æ—¶çš„å€¼ `0`ã€‚å³ä½¿åæ¥ `count` å˜äº†ï¼Œè¿™ä¸ªå›è°ƒé‡Œçš„ `count` è¿˜æ˜¯ `0`ã€‚

### è§£å†³æ–¹æ¡ˆä¸€ï¼šå‡½æ•°å¼æ›´æ–°

```tsx
// âŒ é—­åŒ…é™·é˜±
setCount(count + 1);     // count æ°¸è¿œæ˜¯æ—§å€¼

// âœ… å‡½æ•°å¼æ›´æ–°
setCount(prev => prev + 1);  // React ä¼ å…¥æœ€æ–°å€¼
```

```
å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  setCount(count + 1)                                    â”‚
â”‚  â””â”€ "æŠŠ count è®¾ä¸º count + 1"                           â”‚
â”‚  â””â”€ éœ€è¦çŸ¥é“ count å½“å‰æ˜¯å¤šå°‘ â† ä¾èµ–é—­åŒ…ä¸­çš„æ—§å€¼ï¼        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  setCount(prev => prev + 1)                             â”‚
â”‚  â””â”€ "æŠŠ count è®¾ä¸º (å½“å‰å€¼ + 1)"                        â”‚
â”‚  â””â”€ React ä¼ å…¥æœ€æ–°å€¼ â† ä¸ä¾èµ–é—­åŒ…ï¼                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§£å†³æ–¹æ¡ˆäºŒï¼šåŠ å…¥ä¾èµ–æ•°ç»„

```tsx
useEffect(() => {
  const timer = setInterval(() => {
    setCount(count + 1);
  }, 1000);
  return () => clearInterval(timer);
}, [count]);  // count å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œ
```

**ç¼ºç‚¹**ï¼šå®šæ—¶å™¨ä¼šåå¤é”€æ¯é‡å»ºï¼Œä¸å¤Ÿä¼˜é›…ã€‚

### è§£å†³æ–¹æ¡ˆä¸‰ï¼šuseRef é€ƒç”Ÿèˆ±

å½“éœ€è¦åœ¨å›è°ƒä¸­**è¯»å–**æœ€æ–°å€¼ï¼ˆè€Œéæ›´æ–°ï¼‰æ—¶ï¼Œä½¿ç”¨ `useRef`ï¼š

```tsx
const countRef = useRef(count);

// åŒæ­¥æœ€æ–°å€¼åˆ° ref
useEffect(() => {
  countRef.current = count;
}, [count]);

// åœ¨å»¶è¿Ÿå›è°ƒä¸­è¯»å–æœ€æ–°å€¼
const handleDelayed = () => {
  setTimeout(() => {
    console.log(countRef.current);  // æ€»æ˜¯æœ€æ–°å€¼ï¼
  }, 2000);
};
```

> [!tip] useRef ä¸ºä»€ä¹ˆèƒ½è§£å†³ï¼Ÿ
> `useRef` è¿”å›ä¸€ä¸ª**å¯å˜å¯¹è±¡**ï¼Œå®ƒçš„ `.current` å±æ€§å¯ä»¥éšæ—¶ä¿®æ”¹ã€‚é—­åŒ…æ•è·çš„æ˜¯**è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨**ï¼ˆä¸å˜ï¼‰ï¼Œè€Œå¯¹è±¡çš„å†…å®¹ï¼ˆ`.current`ï¼‰å¯ä»¥æ›´æ–°ã€‚è¿™å°±åƒé—­åŒ…æ‹äº†å¼ ã€Œç›¸æ¡†ã€çš„ç…§ç‰‡ï¼Œä½†ç›¸æ¡†é‡Œçš„ç…§ç‰‡å¯ä»¥æ¢ã€‚

---

## ğŸ“¦ ä¾èµ–æ•°ç»„è¯¦è§£

### é»„é‡‘æ³•åˆ™

> **Effect å†…éƒ¨ç”¨åˆ°çš„ã€æ¥è‡ªç»„ä»¶çš„å€¼ï¼Œéƒ½è¦æ”¾è¿›ä¾èµ–æ•°ç»„**

### é€ŸæŸ¥è¡¨

| å€¼çš„ç±»å‹ | æ˜¯å¦éœ€è¦åŠ å…¥ä¾èµ– | åŸå›  |
|---------|-----------------|------|
| **props** | âœ… éœ€è¦ | å¯èƒ½ä¼šå˜åŒ– |
| **state** | âœ… éœ€è¦ | å¯èƒ½ä¼šå˜åŒ– |
| **ç»„ä»¶å†…å®šä¹‰çš„å˜é‡/å‡½æ•°** | âœ… éœ€è¦ | æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°çš„ |
| **setState å‡½æ•°** | âŒ ä¸éœ€è¦ | React ä¿è¯ç¨³å®š |
| **useRef çš„ ref å¯¹è±¡** | âŒ ä¸éœ€è¦ | React ä¿è¯ç¨³å®š |
| **ç»„ä»¶å¤–éƒ¨çš„å¸¸é‡** | âŒ ä¸éœ€è¦ | æ°¸è¿œä¸å˜ |

### ç¤ºä¾‹

```tsx
const API_URL = 'https://api.example.com';  // ç»„ä»¶å¤–å¸¸é‡

function UserPosts({ userId, sortOrder }) {  // props
  const [posts, setPosts] = useState([]);    // state

  useEffect(() => {
    fetch(`${API_URL}/users/${userId}/posts?sort=${sortOrder}`)
    //     ^^^^^^^ ä¸éœ€è¦  ^^^^^^ éœ€è¦      ^^^^^^^^^ éœ€è¦
      .then(res => res.json())
      .then(setPosts);
    //     ^^^^^^^^ ä¸éœ€è¦ï¼ˆsetter ç¨³å®šï¼‰
  }, [userId, sortOrder]);  // âœ… åªéœ€è¦ props
}
```

---

## âš ï¸ å¯¹è±¡/å‡½æ•°ä¾èµ–é™·é˜±

### é—®é¢˜ï¼šæ— é™å¾ªç¯

```tsx
function SearchBox() {
  const options = { limit: 10 };  // ğŸš¨ æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°å¯¹è±¡ï¼

  useEffect(() => {
    search(options);
  }, [options]);  // options æ¯æ¬¡éƒ½ã€Œå˜ã€â†’ æ— é™å¾ªç¯ï¼
}
```

### åŸå› 

```tsx
// JavaScript å¼•ç”¨ç›¸ç­‰æ€§
{ limit: 10 } === { limit: 10 }  // falseï¼ä¸åŒå¯¹è±¡

// æ¯æ¬¡æ¸²æŸ“
const options = { limit: 10 };  // æ–°å¯¹è±¡
const options = { limit: 10 };  // åˆä¸€ä¸ªæ–°å¯¹è±¡
// React è®¤ä¸ºä¾èµ–å˜äº† â†’ é‡æ–°æ‰§è¡Œ effect â†’ åˆæ¸²æŸ“...
```

### è§£å†³æ–¹æ¡ˆ

```tsx
// æ–¹æ¡ˆ 1ï¼šç§»åˆ° useEffect å†…éƒ¨
useEffect(() => {
  const options = { limit: 10 };
  search(options);
}, []);

// æ–¹æ¡ˆ 2ï¼šç§»åˆ°ç»„ä»¶å¤–éƒ¨ï¼ˆå¦‚æœä¸ä¾èµ– props/stateï¼‰
const options = { limit: 10 };
function SearchBox() { ... }

// æ–¹æ¡ˆ 3ï¼šuseMemo ç¼“å­˜
const options = useMemo(() => ({ limit: 10 }), []);
```

---

## ğŸƒ ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰

### é—®é¢˜åœºæ™¯

```
æ—¶é—´çº¿ï¼šuserId ä» 1 å¿«é€Ÿåˆ‡æ¢åˆ° 2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
â”œâ”€ userId=1ï¼Œå‘èµ·è¯·æ±‚ Aï¼ˆæ…¢ï¼Œ500msï¼‰
â”œâ”€ userId=2ï¼Œå‘èµ·è¯·æ±‚ Bï¼ˆå¿«ï¼Œ100msï¼‰
â”‚        â”‚     â”‚
â”‚        â”‚     â””â”€ è¯·æ±‚ B è¿”å› â†’ setUser(ç”¨æˆ·2) âœ…
â”‚        â””â”€ è¯·æ±‚ A è¿”å› â†’ setUser(ç”¨æˆ·1) ğŸš¨ è¦†ç›–äº†ï¼

ç»“æœï¼šæ˜¾ç¤ºç”¨æˆ·1ï¼Œä½†å½“å‰ userId æ˜¯ 2ï¼
```

### è§£å†³æ–¹æ¡ˆï¼šcancelled æ ‡è®°

```tsx
useEffect(() => {
  let cancelled = false;  // æ ‡è®°

  fetchUser(userId).then(data => {
    if (!cancelled) {     // åªæœ‰æœªå–æ¶ˆæ—¶æ‰æ›´æ–°
      setUser(data);
    }
  });

  return () => {
    cancelled = true;     // æ¸…ç†æ—¶æ ‡è®°ä¸ºå·²å–æ¶ˆ
  };
}, [userId]);
```

```mermaid
sequenceDiagram
    participant E1 as Effect 1 (userId=1)
    participant E2 as Effect 2 (userId=2)
    participant API as API
    participant UI as UI

    E1->>API: è¯·æ±‚ç”¨æˆ·1ï¼ˆæ…¢ï¼‰
    Note over E1: cancelled = false

    E2->>E1: è§¦å‘æ¸…ç†
    Note over E1: cancelled = true

    E2->>API: è¯·æ±‚ç”¨æˆ·2ï¼ˆå¿«ï¼‰
    Note over E2: cancelled = false

    API-->>E2: è¿”å›ç”¨æˆ·2
    E2->>UI: setUser(ç”¨æˆ·2) âœ…

    API-->>E1: è¿”å›ç”¨æˆ·1
    Note over E1: cancelled=trueï¼Œå¿½ç•¥ï¼
```

---

## ğŸ’¡ ç®­å¤´å‡½æ•°æ¸…ç†å‡½æ•°çš„å°å‘

```tsx
// âŒ é”™è¯¯ï¼šéšå¼è¿”å› boolean
return () => cancelled = true
// ç­‰ä»·äº return () => { return cancelled = true }
// è¿”å›ç±»å‹æ˜¯ booleanï¼ŒTypeScript æŠ¥é”™

// âœ… æ­£ç¡®ï¼šèŠ±æ‹¬å·åŒ…è£¹
return () => { cancelled = true }
// è¿”å› voidï¼Œç¬¦åˆæ¸…ç†å‡½æ•°ç±»å‹
```

> [!tip] æœ€ä½³å®è·µ
> æ¸…ç†å‡½æ•°æ€»æ˜¯ä½¿ç”¨èŠ±æ‹¬å·ï¼Œæ„å›¾æ›´æ¸…æ™°ã€ç±»å‹æ›´å®‰å…¨ã€‚

---

## ğŸ“ ä¸‰å¤§æŠ€å·§æ€»ç»“

| é—®é¢˜ | æŠ€å·§ | ä»£ç  |
|------|------|------|
| å®šæ—¶å™¨ä¸­æ›´æ–°çŠ¶æ€ | å‡½æ•°å¼æ›´æ–° | `setCount(prev => prev + 1)` |
| å»¶è¿Ÿå›è°ƒè¯»å–æœ€æ–°å€¼ | useRef é€ƒç”Ÿèˆ± | `countRef.current` |
| å¼‚æ­¥è¯·æ±‚é¡ºåºé—®é¢˜ | cancelled æ ‡è®° | `if (!cancelled) { ... }` |

---

## âœï¸ ç»ƒä¹ 

| ç»ƒä¹ æ–‡ä»¶ | éªŒè¯å‘½ä»¤ |
|----------|----------|
| [03-useeffect-advanced.tsx](idea://open?file=/Users/linqibin/Desktop/Patra/patra-react-playground/src/exercises/ch03/03-useeffect-advanced.tsx) | `pnpm test 03-useeffect-advanced` |

**ç»ƒä¹ å†…å®¹**ï¼š
- ç»ƒä¹  1ï¼šé¢„æµ‹é—­åŒ…é™·é˜±ç»“æœ
- ç»ƒä¹  2Aï¼šå‡½æ•°å¼æ›´æ–°ä¿®å¤å®šæ—¶å™¨
- ç»ƒä¹  2Bï¼šuseRef ä¿å­˜æœ€æ–°å€¼
- ç»ƒä¹  3ï¼šä¾èµ–æ•°ç»„åˆ¤æ–­ä¸ä¿®å¤
- ç»ƒä¹  4ï¼šcancelled æ ‡è®°ä¿®å¤ç«æ€æ¡ä»¶

**å®ŒæˆçŠ¶æ€**ï¼šâœ… 9/9 æµ‹è¯•é€šè¿‡

---

## ğŸ”— ç›¸å…³çŸ¥è¯†

- [[02-useeffect-basics|useEffect åŸºç¡€]] â€” ä¾èµ–æ•°ç»„å’Œæ¸…ç†å‡½æ•°çš„åŸºç¡€ç”¨æ³•
- [[02-useeffect-basics#âš ï¸ é‡è¦ï¼šsetState çš„è°ƒç”¨ä½ç½®|setState è°ƒç”¨ä½ç½®]] â€” ç†è§£ useEffect ä¸­è°ƒç”¨ setState ä¸ºä»€ä¹ˆå®‰å…¨
- [[04-useref|useRef]] â€” ä¸‹ä¸€èŠ‚æ·±å…¥å­¦ä¹  useRef çš„æ›´å¤šç”¨æ³•

---

## ğŸ”— å¯¼èˆª

- ä¸Šä¸€èŠ‚ï¼š[[02-useeffect-basics|useEffect åŸºç¡€]]
- ä¸‹ä¸€èŠ‚ï¼š[[04-useref|useRef]]

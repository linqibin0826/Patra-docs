# D2 声明式图表规范

> 适用场景：复杂架构图、ERD 数据库建模、UML 类图、序列图、嵌套容器拓扑

## 强制规则

1. ID 与 Label 分离：ID 仅英文+下划线，Label 通过属性设置中文
2. 禁止隐式声明：所有节点必须显式定义 `shape`
3. 禁止内联样式：使用 `classes` 集中管理
4. 块语法优先：复杂配置使用 `{}` 块语法
5. 统一连接方向：全部使用 `->`，禁止 `<-`

## 标识符规范

| 元素 | 规范 | 示例 |
|------|------|------|
| 节点 ID | `snake_case`，仅英文+数字+下划线 | `user_service` |
| 容器 ID | 同上，语义化命名 | `k8s_cluster` |
| 连接标签 | 动词短语 | `Reads from` |

**保留关键字**（需引号包裹）：`shape`、`style`、`label`、`icon`、`near`、`vars`、`classes`、`tooltip`

## 容器与嵌套

**禁止**点标记法隐式创建，**必须**使用块语法：

```d2
aws: AWS Cloud {
  shape: cloud
  region_us: US East {
    vpc: Primary VPC {
      web_server: {shape: square}
    }
  }
}
```

**容器形状**：`cloud`（云环境）、`package`（模块）、`cylinder`（数据库）、`hexagon`（服务）

## 连接规范

| 符号 | 含义 | 使用场景 |
|------|------|----------|
| `->` | 单向（推荐） | 数据流、调用关系 |
| `<->` | 双向 | 双向通信 |
| `--` | 无向 | 物理连接 |
| `<-` | 反向（禁止） | — |

## 样式系统

**必须使用 classes**：

```d2
classes: {
  datastore: {
    shape: cylinder
    style: {
      fill: "#ede9fe"
      stroke: "#8b5cf6"
      font-color: "#1e293b"
    }
  }
}

UserDB.class: datastore
```

### 语义化颜色（Tailwind CSS）

| 用途 | 背景色 | 边框色 |
|------|--------|--------|
| 容器/层 | `#f8fafc` | `#64748b` |
| 默认节点 | `#dbeafe` | `#3b82f6` |
| 服务/处理 | `#dcfce7` | `#22c55e` |
| 存储/数据 | `#ede9fe` | `#8b5cf6` |
| 告警/错误 | `#fecaca` | `#ef4444` |

## 特定领域建模

### SQL 表

```d2
users: {
  shape: sql_table
  id: uuid {constraint: primary_key}
  role_id: int {constraint: foreign_key}
}
users.role_id -> roles.id
```

### UML 类图

```d2
AuthManager: {
  shape: class
  -sessionPool: Map<String, Session>
  +validate(token: string): bool
}
```

可见性：`+` public、`-` private、`#` protected

### 序列图

```d2
shape: sequence_diagram
User -> UI: 点击查询
UI -> Server: GET /api/data
```

## 布局引擎

| 引擎 | 适用场景 |
|------|----------|
| `dagre` | 简单流程图 |
| `elk` | 微服务架构（推荐） |
| `tala` | ERD、对称布局 |

```d2
vars: {
  d2-config: {
    layout-engine: elk
  }
}
```

## 禁止行为

1. 禁止 ID 使用中文
2. 禁止内联样式硬编码
3. 禁止使用 `<-` 反向箭头
4. 禁止点标记法隐式创建深层嵌套
